cmake_minimum_required(VERSION 3.16)

project(libc C ASM)

# Configuration variables
set(HOSTARCH "i386" CACHE STRING "Target architecture")

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# Compiler flags for freestanding libc
set(LIBC_CFLAGS
    -ffreestanding
    -Wall
    -Wextra
    -fno-stack-protector
    -fno-pic
    -mno-80387
    -mno-mmx
    -mno-sse
    -mno-sse2
)

# Additional flags for libk (kernel version)
set(LIBK_CFLAGS ${LIBC_CFLAGS})
set(LIBK_CPPFLAGS -D__is_libk)

# Freestanding objects (work in both kernel and userspace)
set(FREESTANDING_SOURCES
    stdio/printf.c
    stdio/putchar.c
    stdio/puts.c
    string/memcmp.c
    string/memcpy.c
    string/memmove.c
    string/memset.c
    string/strlen.c
)

# Architecture-specific sources (currently empty for i386)
set(ARCH_FREESTANDING_SOURCES
    # Add arch-specific sources here if needed
)

# All sources for the library
set(ALL_SOURCES
    ${FREESTANDING_SOURCES}
    ${ARCH_FREESTANDING_SOURCES}
)

# Build libk.a (kernel version of libc)
add_library(libk STATIC ${ALL_SOURCES})

# Set target properties for libk
target_compile_options(libk PRIVATE ${LIBK_CFLAGS})
target_compile_definitions(libk PRIVATE ${LIBK_CPPFLAGS})
set_target_properties(libk PROPERTIES
    OUTPUT_NAME "k"
    ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/libc
    C_STANDARD 11
    C_STANDARD_REQUIRED ON
    C_EXTENSIONS ON  # Use gnu11 for compatibility
)

# Optional: Build libc.a (userspace version) - currently not fully implemented
# Uncomment when ready for hosted environment
# add_library(libc STATIC ${ALL_SOURCES})
# target_compile_options(libc PRIVATE ${LIBC_CFLAGS})
# target_compile_definitions(libc PRIVATE -D__is_libc)
# set_target_properties(libc PROPERTIES
#     OUTPUT_NAME "c"
#     ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/libc
#     C_STANDARD 11
#     C_STANDARD_REQUIRED ON
#     C_EXTENSIONS ON
# )

# Installation rules
install(TARGETS libk
    ARCHIVE DESTINATION lib
)

install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/include/
    DESTINATION include
    FILES_MATCHING PATTERN "*.h"
)

# Print build information
message(STATUS "Building libc for architecture: ${HOSTARCH}")
message(STATUS "libk will be installed to: ${CMAKE_INSTALL_PREFIX}/lib")
message(STATUS "Headers will be installed to: ${CMAKE_INSTALL_PREFIX}/include")
